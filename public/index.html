<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EasyPost Embeddables Demo</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        margin: 24px;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 16px;
        max-width: 980px;
      }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: end;
      }
      button {
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid #ccc;
        background: #fff;
        cursor: pointer;
      }
      button.primary {
        border-color: #164dff;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      input,
      select {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #ccc;
        min-width: 360px;
      }
      .muted {
        color: #666;
        font-size: 14px;
      }
      .log {
        margin-top: 12px;
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        white-space: pre-wrap;
        background: #fafafa;
        border: 1px solid #eee;
        padding: 12px;
        border-radius: 12px;
      }
      .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .field label {
        font-size: 14px;
        color: #444;
      }
      code {
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      }
    </style>
  </head>

  <body>
    <h1>EasyPost Embeddables Demo</h1>

    <div class="card">
      <div class="row">
        <div class="field">
          <label class="muted">Child Users (from Production API key)</label>
          <select id="childUserSelect" disabled>
            <option value="">Loading child users‚Ä¶</option>
          </select>
        </div>

        <button id="btnRefreshUsers">Refresh Users</button>

        <button id="btnInit" class="primary" disabled>Initialize SDK</button>
        <button id="btnTheme" disabled>Toggle Theme</button>
      </div>

      <div class="row" style="margin-top: 12px">
        <div class="field">
          <label class="muted">Manual user_id (optional fallback)</label>
          <input id="manualUserId" placeholder="e.g. user_123..." />
        </div>

        <button id="btnUseManual">Use Manual user_id</button>
      </div>

      <p class="muted" style="margin-top: 10px">
        This demo calls <code>/api/easypost-embeddables/child-users</code> to
        list child users, then calls
        <code>/api/easypost-embeddables/session</code> to mint a short-lived
        <code>session_id</code>.
      </p>

      <hr style="border: none; border-top: 1px solid #eee; margin: 16px 0" />

      <div class="row">
        <button id="button-billing" disabled>Manage Billing</button>
        <button id="button-carriers">Manage Carriers</button>
        <button id="button-payment-logs" disabled>Payment Logs</button>
        <button id="button-reports" disabled>Reports</button>
      </div>

      <div id="log" class="log">Log:</div>
    </div>

    <!-- Load EasyPost Embeddables -->
    <script
      src="https://embed.easypost.com/embeddables/1.0/client.js"
      async
    ></script>

    <script>
      // -----------------------------
      // Logging
      // -----------------------------
      const logEl = document.getElementById("log");
      const log = (...args) => {
        logEl.textContent +=
          args
            .map((a) =>
              typeof a === "string" ? a : JSON.stringify(a, null, 2),
            )
            .join(" ") + "\n";
      };

      // -----------------------------
      // State (declare ONCE)
      // -----------------------------
      let embeddables = null;
      let dark = false;

      // Selected user_id from dropdown/manual
      let selectedUserId = "";

      // user_id currently bound to the live embeddables instance/session
      let activeUserId = "";

      const childUserSelect = document.getElementById("childUserSelect");
      const btnInit = document.getElementById("btnInit");
      const btnTheme = document.getElementById("btnTheme");

      // -----------------------------
      // UI helpers
      // -----------------------------
      const setButtonsEnabled = (enabled) => {
        [
          "button-billing",
          "button-carriers",
          "button-payment-logs",
          "button-reports",
        ].forEach((id) => {
          document.getElementById(id).disabled = !enabled;
        });
        btnTheme.disabled = !enabled;
      };

      const updateInitEnabled = () => {
        const hasUser = Boolean(selectedUserId);
        btnInit.disabled = !hasUser;
      };

      const resetEmbeddables = () => {
        if (embeddables?.destroy) {
          try {
            embeddables.destroy();
          } catch (e) {
            // best-effort teardown
          }
        }
        embeddables = null;
        activeUserId = "";
        setButtonsEnabled(false);
        updateInitEnabled();
        log("üîÅ Reset embeddables (user changed). Click Initialize SDK again.");
      };

      const openComponent = async (type) => {
        if (!embeddables) {
          log("‚ÑπÔ∏è Initialize the SDK first.");
          return;
        }
        if (selectedUserId !== activeUserId) {
          log(
            "‚ö†Ô∏è User changed. Re-initialize the SDK to load the new child user.",
          );
          return;
        }
        try {
          await embeddables.open(type);
        } catch (e) {
          log("‚ùå Failed to open component:", e?.message || String(e));
        }
      };

      // -----------------------------
      // Theme
      // -----------------------------
      const getAppearance = () => ({
        tokens: dark
          ? {
              "font.family": "calibri, sans-serif",
              "color.neutral.000": "#1f2937",
              "color.neutral.900": "#ffffff",
            }
          : {
              "font.family": "calibri, sans-serif",
              "color.neutral.000": "#ffffff",
            },
        modalZIndex: "123456",
      });

      // -----------------------------
      // Data loading: child users
      // -----------------------------
      const loadChildUsers = async () => {
        childUserSelect.disabled = true;
        childUserSelect.innerHTML = `<option value="">Loading child users‚Ä¶</option>`;

        // Clear selection state until a user is chosen
        selectedUserId = "";
        updateInitEnabled();

        try {
          const resp = await fetch("/api/easypost-embeddables/child-users");
          const data = await resp.json();

          if (!resp.ok) {
            log("‚ùå Failed to load child users:", data);
            childUserSelect.innerHTML = `<option value="">Failed to load users</option>`;
            return;
          }

          const children = Array.isArray(data?.children) ? data.children : [];
          if (children.length === 0) {
            childUserSelect.innerHTML = `<option value="">No child users found</option>`;
            log("‚ÑπÔ∏è No child users returned for this API key.");
            return;
          }

          childUserSelect.innerHTML = `<option value="">Select a child user‚Ä¶</option>`;
          for (const u of children) {
            const label = u.name ? `${u.name} (${u.id})` : u.id;
            const opt = document.createElement("option");
            opt.value = u.id;
            opt.textContent = label;
            childUserSelect.appendChild(opt);
          }

          childUserSelect.disabled = false;
          log(`‚úÖ Loaded ${children.length} child users.`);
        } catch (e) {
          log("‚ùå Network error loading child users:", String(e));
          childUserSelect.innerHTML = `<option value="">Failed to load users</option>`;
        }
      };

      // -----------------------------
      // Session creation for selected child
      // -----------------------------
      const fetchSessionId = async () => {
        if (!selectedUserId) {
          log("‚ùå Missing selected user_id");
          return null;
        }

        try {
          const response = await fetch("/api/easypost-embeddables/session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: selectedUserId }),
          });

          const data = await response.json();

          if (!response.ok) {
            log("‚ùå Session request failed:", data);
            return null;
          }

          log("‚úÖ Got session_id:", data.session_id);
          return data.session_id;
        } catch (error) {
          console.error(
            "[EasyPostEmbeddables] Failed to fetch session ID:",
            error,
          );
          log(
            "‚ùå Failed to fetch session ID:",
            error?.message || String(error),
          );
          return null;
        }
      };

      // -----------------------------
      // Wire UI
      // -----------------------------
      document
        .getElementById("btnRefreshUsers")
        .addEventListener("click", async () => {
          await loadChildUsers();
        });

      childUserSelect.addEventListener("change", () => {
        const next = childUserSelect.value || "";
        if (!next) {
          selectedUserId = "";
          updateInitEnabled();
          return;
        }

        // If the SDK is already initialized for a different child, reset it.
        if (embeddables && activeUserId && next !== activeUserId) {
          selectedUserId = next;
          log("üë§ Selected user_id:", selectedUserId);
          resetEmbeddables();
          return;
        }

        selectedUserId = next;
        log("üë§ Selected user_id:", selectedUserId);
        updateInitEnabled();
      });

      document.getElementById("btnUseManual").addEventListener("click", () => {
        const manual = document.getElementById("manualUserId").value.trim();
        if (!manual) {
          log("‚ùå Manual user_id is empty.");
          return;
        }

        // If switching away from the currently active user, reset the SDK.
        if (embeddables && activeUserId && manual !== activeUserId) {
          selectedUserId = manual;
          log("üë§ Using manual user_id:", selectedUserId);
          resetEmbeddables();
          return;
        }

        selectedUserId = manual;
        log("üë§ Using manual user_id:", selectedUserId);
        updateInitEnabled();
      });

      // -----------------------------
      // EasyPost Embeddables SDK
      // -----------------------------
      window.EasyPostEmbeddables = window.EasyPostEmbeddables || {};
      window.EasyPostEmbeddables.onLoad = () => {
        log("EasyPost Embeddables script loaded.");

        btnInit.addEventListener("click", async () => {
          if (!selectedUserId) {
            log("‚ùå Select a child user first.");
            return;
          }

          // If already initialized for this user, don't re-init.
          if (embeddables && activeUserId === selectedUserId) {
            log("‚ÑπÔ∏è SDK already initialized for this user.");
            setButtonsEnabled(true);
            return;
          }

          // If initialized for another user, reset and continue
          if (embeddables && activeUserId && activeUserId !== selectedUserId) {
            resetEmbeddables();
          }

          if (!window.EasyPostEmbeddables?.init) {
            log("‚ùå SDK not available yet.");
            return;
          }

          embeddables = window.EasyPostEmbeddables.init({
            fetchSessionId,
            fonts: [
              {
                cssSrc:
                  "https://fonts.googleapis.com/css2?family=Zen+Dots&display=swap",
              },
            ],
            appearance: getAppearance(),
          });

          activeUserId = selectedUserId;
          log("‚úÖ SDK initialized.");
          log("üîí Embeddables bound to user_id:", activeUserId);

          setButtonsEnabled(true);
        });

        btnTheme.addEventListener("click", async () => {
          if (!embeddables) {
            log("‚ÑπÔ∏è Initialize the SDK first.");
            return;
          }
          dark = !dark;
          await embeddables.update({ appearance: getAppearance() });
          log("üé® Theme toggled. dark =", dark);
        });

        document
          .getElementById("button-billing")
          .addEventListener("click", async () => {
            await openComponent("manage-billing");
          });
        document
          .getElementById("button-carriers")
          .addEventListener("click", async () => {
            await openComponent("manage-carriers");
          });
        document
          .getElementById("button-payment-logs")
          .addEventListener("click", async () => {
            await openComponent("manage-payment-logs");
          });
        document
          .getElementById("button-reports")
          .addEventListener("click", async () => {
            await openComponent("manage-reports");
          });
      };

      // -----------------------------
      // Initial load
      // -----------------------------
      setButtonsEnabled(false);
      updateInitEnabled();
      loadChildUsers();
    </script>
  </body>
</html>

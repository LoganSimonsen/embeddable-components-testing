<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EasyPost Embeddables Demo</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        margin: 24px;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 16px;
        max-width: 900px;
      }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }
      button {
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid #ccc;
        background: #fff;
        cursor: pointer;
      }
      button.primary {
        border-color: #164dff;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      input,
      select {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #ccc;
        min-width: 340px;
      }
      .muted {
        color: #666;
        font-size: 14px;
      }
      .log {
        margin-top: 12px;
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        white-space: pre-wrap;
        background: #fafafa;
        border: 1px solid #eee;
        padding: 12px;
        border-radius: 12px;
      }
    </style>
  </head>
  <body>
    <h1>EasyPost Embeddables Demo</h1>

    <div class="card">
      <div class="row">
        <label>
          <div class="muted">Sub-account user_id</div>
          <input id="userId" placeholder='e.g. "user_123..."' />
        </label>

        <button id="btnInit" class="primary">Initialize SDK</button>

        <button id="btnTheme">Toggle Theme</button>
      </div>

      <p class="muted" style="margin-top: 10px">
        This demo calls <code>/api/easypost-embeddables/session</code> to mint a
        short-lived <code>session_id</code>. The EasyPost modal is opened from
        EasyPost-hosted iframes.
      </p>

      <hr style="border: none; border-top: 1px solid #eee; margin: 16px 0" />

      <div class="row">
        <button id="button-billing" disabled>Manage Billing</button>
        <button id="button-carriers" disabled>Manage Carriers</button>
        <button id="button-payment-logs" disabled>Payment Logs</button>
        <button id="button-reports" disabled>Reports</button>
      </div>

      <div id="log" class="log">Log:\n</div>
    </div>

    <!-- Load EasyPost Embeddables -->
    <script
      src="https://embed.easypost.com/embeddables/1.0/client.js"
      async
    ></script>

    <script>
      const logEl = document.getElementById("log");
      const log = (...args) => {
        logEl.textContent +=
          args
            .map((a) =>
              typeof a === "string" ? a : JSON.stringify(a, null, 2),
            )
            .join(" ") + "\n";
      };

      const state = {
        embeddables: null,
        dark: false,
      };

      // --- Robust backdrop (blue tint) fixer ---
      function isMostlyFullscreen(el) {
        const r = el.getBoundingClientRect();
        return (
          r.width >= window.innerWidth - 8 && r.height >= window.innerHeight - 8
        );
      }

      function bgIsVisible(bg) {
        if (!bg) return false;
        if (bg === "transparent") return false;
        // rgba(0, 0, 0, 0) etc.
        if (bg.startsWith("rgba")) {
          const m = bg.match(
            /rgba\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*,\s*([0-9.]+)\s*\)/i,
          );
          if (m && Number(m[1]) === 0) return false;
        }
        return true;
      }

      function fixBackdrop(backdropColor = "rgba(0,0,0,0.35)") {
        const iframe = document.querySelector(
          'iframe[src*="embed.easypost.com"]',
        );
        if (!iframe) return false;

        // Scan *all* elements (not just body children) for a fullscreen fixed overlay.
        const all = Array.from(document.querySelectorAll("body *"));

        // Filter down to likely overlay candidates
        const candidates = all
          .filter((el) => {
            const cs = getComputedStyle(el);
            if (cs.position !== "fixed") return false;
            if (!isMostlyFullscreen(el)) return false;
            if (!bgIsVisible(cs.backgroundColor)) return false;

            // Must not be the modal container (exclude anything containing the iframe)
            if (
              el.querySelector &&
              el.querySelector('iframe[src*="embed.easypost.com"]')
            )
              return false;

            return true;
          })
          .map((el) => {
            const cs = getComputedStyle(el);
            const z = Number.isFinite(parseInt(cs.zIndex, 10))
              ? parseInt(cs.zIndex, 10)
              : 0;
            return { el, z, bg: cs.backgroundColor };
          });

        if (!candidates.length) return false;

        // Choose the top-most overlay by z-index (most likely the scrim)
        candidates.sort((a, b) => b.z - a.z);
        const overlay = candidates[0].el;

        overlay.style.background = backdropColor;
        overlay.style.backdropFilter = "none";
        overlay.style.webkitBackdropFilter = "none";

        return true;
      }

      async function openEmbeddable(type) {
        await state.embeddables.open(type);

        // Try several times over ~1.5s while the modal mounts/animates
        const times = [0, 50, 150, 300, 600, 1000, 1500];
        times.forEach((t) =>
          setTimeout(() => fixBackdrop("rgba(0,0,0,0.35)"), t),
        );
      }

      // Call your backend to create a session for the selected sub-account
      const fetchSessionId = async () => {
        const user_id = document.getElementById("userId").value.trim();
        if (!user_id) {
          log("âŒ Missing user_id");
          return null;
        }

        try {
          const resp = await fetch("/api/easypost-embeddables/session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id }),
          });

          const data = await resp.json();
          if (!resp.ok) {
            log("âŒ Session request failed:", data);
            return null;
          }

          log("âœ… Got session_id:", data.session_id);
          return data.session_id;
        } catch (e) {
          log("âŒ Network error:", String(e));
          return null;
        }
      };

      const setButtonsEnabled = (enabled) => {
        [
          "button-billing",
          "button-carriers",
          "button-payment-logs",
          "button-reports",
        ].forEach((id) => {
          document.getElementById(id).disabled = !enabled;
        });
      };

      const makeTheme = (dark) => {
        return {
          tokens: dark
            ? {
                "color.neutral.000": { value: "#0b0f1a" },
                "color.neutral.900": { value: "#ffffff" },
                "color.primary.500": { value: "#9F39EE" },
                "font.family": { value: 'Poppins, "Poppins Fallback"' },
              }
            : {
                "color.neutral.000": { value: "#FFFFFF" },
                "color.neutral.900": { value: "#000000" },
                "color.primary.500": { value: "#164DFF" },
                "font.family": { value: 'Poppins, "Poppins Fallback"' },
              },
          modalZIndex: "123456",
        };
      };

      window.EasyPostEmbeddables = window.EasyPostEmbeddables || {};
      window.EasyPostEmbeddables.onLoad = () => {
        log("EasyPost Embeddables script loaded.");

        document
          .getElementById("btnInit")
          .addEventListener("click", async () => {
            if (!window.EasyPostEmbeddables?.init) {
              log("âŒ SDK not available yet.");
              return;
            }

            state.embeddables = window.EasyPostEmbeddables.init({
              fetchSessionId,
              fonts: [
                {
                  cssSrc:
                    "https://fonts.googleapis.com/css2?family=Zen+Dots&display=swap",
                },
              ],
              appearance: makeTheme(state.dark),
            });

            log("âœ… SDK initialized.");
            setButtonsEnabled(true);
          });

        document
          .getElementById("btnTheme")
          .addEventListener("click", async () => {
            if (!state.embeddables) {
              log("â„¹ï¸ Initialize the SDK first.");
              return;
            }
            state.dark = !state.dark;
            await state.embeddables.update({
              appearance: makeTheme(state.dark),
            });
            log("ðŸŽ¨ Theme updated. dark =", state.dark);
          });

        document
          .getElementById("button-billing")
          .addEventListener("click", async () => {
            await openEmbeddable("manage-billing");
          });
        document
          .getElementById("button-carriers")
          .addEventListener("click", async () => {
            await openEmbeddable("manage-carriers");
          });
        document
          .getElementById("button-payment-logs")
          .addEventListener("click", async () => {
            await openEmbeddable("manage-payment-logs");
          });
        document
          .getElementById("button-reports")
          .addEventListener("click", async () => {
            await openEmbeddable("manage-reports");
          });
      };
    </script>
  </body>
</html>
